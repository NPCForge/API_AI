version: "3.9"

services:
    postgres:
        image: postgres:16
        restart: always
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-npcforge}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-npcforge}
            POSTGRES_DB: ${POSTGRES_DB:-npcforge}
        volumes:
            - db_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
            interval: 5s
            timeout: 3s
            retries: 20
        ports:
            - "5432:5432"

    api:
        build:
            context: .
            dockerfile: Dockerfile
        restart: always
        depends_on:
            postgres:
                condition: service_healthy
        environment:
            POSTGRES_HOST: postgres
            POSTGRES_PORT: 5432
            POSTGRES_DB: ${POSTGRES_DB:-npcforge}
            POSTGRES_USER: ${POSTGRES_USER:-npcforge}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-npcforge}
            API_KEY_REGISTER: ${API_KEY_REGISTER:-changeme}
            JWT_SECRET_KEY: ${JWT_SECRET_KEY:-changeme}
            CHATGPT_TOKEN: ${CHATGPT_TOKEN:-none}
        ports:
            - "3000:3000"

volumes:
    db_data:
